name: Codechecker

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  codechecker:
    runs-on: ubuntu-latest

    steps:
      # Check YOUR project out!
      - name: "Check out repository"
        uses: actions/checkout@v2

      - name: Set reusable strings
        # Turn repeated input strings (such as the build output directory) into step outputs. These step outputs can be used throughout the workflow file.
        id: strings
        shell: bash
        run: |
          echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

      # Prepare a build
      - name: "Prepare build"
        run: |
          mkdir -B ${{ steps.strings.outputs.build-output-dir }} -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      # Analyse
      - name: "Analyze"
        run: |
          cd build
          cmake --build ${{ steps.strings.outputs.build-output-dir }} --target analyze

      # Create report
      - name: "Create report"
        run: |
          cd build
          cmake --build ${{ steps.strings.outputs.build-output-dir }} --target analyze_report

      # Upload the results to the CI.
      - uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: "CodeChecker Bug Reports"
          path: ${{ steps.strings.outputs.build-output-dir }}/codechecker_html_report
